<head>
    <!-- build:css composition.js -->
    <script src="bower_components/jquery/dist/jquery.min.js"></script>
    <script src="js/composition.js"></script>
    <script src="bower_components/lodash/lodash.min.js"></script>
    <script src="bower_components/handlebars/handlebars.min.js"></script>
    <!-- endbuild -->

    <!-- build:css composition.css -->
    <link href="css/common.css" rel="stylesheet">
    <link href="css/composition.css" rel="stylesheet">
    <!-- endbuild -->

</head>
<!-- TODO textarea to avoid idea formating -->
<textarea id="script-template" title="" style="width: 100%" rows="20">
var orderid = -1;
var init = function(){
  {{#join allIndicators separator="\n  "}}{{/join}}
};
var onTick = function(tick){
  switch (env.marketAdapter.orderStatus(orderId)) {
    case ORDER_STATUS.UNKNOWN :
    case ORDER_STATUS.CANCELLED :
    case ORDER_STATUS.CLOSED :
      openOrderIfNeeded(tick);
    Case ORDER_STATUS.OPENED :
      closeOrderIfNeeded(tick);
      break;
  }
}

var openOrderIfNeeded(tick){
  {{#each openBlocks}}
  if ({{#join expressions separator=" ||\n      "}}{{/join}}){
    orderId = env.marketAdapter.sendOrder({symbol: env.symbol, amount: {{order.amount}}, type: "market", side: {{order.side}} }, tick);
  }
  {{/each}}
}

var closeOrderIfNeeded(tick){
  var order = env.marketAdapter.getOrder(orderId);
  {{#each closeBlocks}}
  if ({{#join expressions separator=" ||\n      "}}{{/join}}){
    env.marketAdapter.closeOrder(orderId, (order.side == 'buy')?tick.bid:tick.sell, order.amount, tick);
  }
  {{/each}}
}
</textarea>


<script>
    var composition = new Composition();
    var scriptTemplate;

    Handlebars.registerHelper('join', function (items, options) {
        return items.map(function (item) {
            return item;
        }).join(options.hash.separator.replace("\\n", "\n") || ", ");
    });


    $(function () {

        composition.addOrCondition('#openConditions', true);
        composition.addOrCondition('#closeConditions', false);


        $("#agentComposition").on('click change keydown keypress keyup', "input, select", function () {
            composition.refreshStatus(this);
        });

        scriptTemplate = Handlebars.compile($('#script-template').val());
    });
</script>

<div class="component" id="agentComposition">
    <h1>Agent composition</h1>

    <h2>Open Position</h2>


    <div class="component_content">
        <div id="openConditions">

        </div>
        <button onclick="composition.addOrCondition('#openConditions', true)" class="new_condition">
            Add new conditions to open a position
        </button>
    </div>


    <h2>Close Position</h2>

    <div class="component_content">
        <div id="closeConditions">

        </div>
        <button onclick="composition.addOrCondition('#closeConditions', false)" class="new_condition">
            Add new conditions to close a position
        </button>
    </div>


    <h2>
        <button type="button" class="generate_script"
                onclick="/* TODO remove*/ scriptTemplate = Handlebars.compile($('#script-template').val()); composition.generateScript(scriptTemplate)">
            Generate
            Script
        </button>
    </h2>

</div>

<pre>
<code id="json"></code>
<code id="script"></code>
</pre>